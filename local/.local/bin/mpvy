#!/bin/bash -
set -o nounset                                  # Treat unset variables as an error

mkdir -p "${HOME}/log"

if [[ $# -eq 0 ]]; then
  echo "Usage: mpvy <playlist_id>"
  exit 1
else
  playlist_id="$1"
  playlist_url="https://www.youtube.com/playlist?list=${playlist_id}"

  echo "Fetching playlist info..."
  yt-dlp --flat-playlist --dump-json "$playlist_url" | jq -r '
    .title as $title
    | "[\(.playlist_index)] \(.title)"
  ' || echo "⚠️ Failed to retrieve playlist info."
  echo ""
  echo "Playing... Press q to stop."
  mpv --log-file=${HOME}/log/mpv_$(date +%Y%m%d_%H%M).log \
      --no-video \
      --shuffle \
      --ytdl-format=bestaudio \
      --script-opts=ytdl_hook-ytdl_path=yt-dlp \
      --term-playing-msg='Title: ${media-title}' "$playlist_url"
fi
